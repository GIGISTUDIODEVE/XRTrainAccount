<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Unity 클라이언트 연동 – 관리자 포털</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 520px;
      margin: 40px auto;
      padding: 0 16px;
      color: #222;
    }
    h1 {
      font-size: 22px;
      margin-bottom: 4px;
    }
    h2 {
      font-size: 16px;
      margin-top: 24px;
      margin-bottom: 8px;
    }
    p {
      font-size: 13px;
      line-height: 1.6;
      color: #555;
    }
    .card {
      border: 1px solid #e3e3e3;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.03);
      background: #fff;
    }
    button {
      padding: 8px 14px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      font-size: 13px;
      margin: 4px 4px 4px 0;
    }
    button.primary {
      background: #2563eb;
      color: #fff;
    }
    button.secondary {
      background: #f3f4f6;
      color: #111827;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }
    textarea {
      width: 100%;
      min-height: 80px;
      font-size: 11px;
      resize: vertical;
      margin-top: 8px;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #f9fafb;
    }
    #status {
      font-size: 12px;
      color: #4b5563;
      margin-top: 8px;
      white-space: pre-wrap;
    }
    .hint {
      font-size: 11px;
      color: #9ca3af;
      margin-top: 4px;
    }
  </style>
</head>
<body>
  <h1>Unity 클라이언트 연동</h1>
  <p>
    이 페이지에서 <strong>현재 로그인한 관리자 계정</strong>으로
    Unity 클라이언트에서 사용할 <strong>로그인 연동 토큰</strong>을 발급할 수 있습니다.
    발급된 토큰은 Unity 앱에 한 번 붙여넣어 로그인하는 데 사용됩니다.
  </p>

  <div class="card">
    <h2>1. 웹에서 관리자 계정 확인</h2>
    <p>
      먼저 이 브라우저에서 관리자 계정으로 로그인해야 합니다.
      아래 버튼을 눌러 Google 계정으로 로그인해 주세요.
    </p>
    <button id="btn-google-login" class="secondary">Google 계정으로 로그인</button>
    <div id="status"></div>
  </div>

  <div class="card">
    <h2>2. Unity 로그인 연동 토큰 발급</h2>
    <p>
      웹 로그인 상태가 확인되면, Unity 클라이언트에서 동일한 계정으로 로그인할 수 있는
      <strong>연동 토큰</strong>을 발급합니다.
    </p>
    <button id="btn-issue-token" class="primary" disabled>Unity 연동 토큰 발급</button>
    <textarea
      id="token-output"
      readonly
      placeholder="발급된 토큰이 여기에 표시됩니다. Unity 클라이언트의 로그인 화면에 그대로 붙여넣어 주세요."
    ></textarea>
    <p class="hint">
      · 토큰은 일회성 사용을 권장합니다.<br />
      · 보안상 토큰을 다른 사람과 공유하지 마세요.
    </p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
    import {
      getFunctions,
      httpsCallable
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-functions.js";

    // TODO: 여기 firebaseConfig는 실제 프로젝트 설정으로 교체
   const firebaseConfig = {
  apiKey: "AIzaSyCPmnm713iyGIW9aUEZMZDFyrfVTsadXIE",
  authDomain: "trainingsocialacount.firebaseapp.com",
  projectId: "trainingsocialacount",
  storageBucket: "trainingsocialacount.firebasestorage.app",
  messagingSenderId: "421668100128",
  appId: "1:421668100128:web:1dcdbc1bc6e10001904445",
  measurementId: "G-9J8Z8VTTLZ"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const functions = getFunctions(app);

    const $ = (id) => document.getElementById(id);
    const btnGoogle = $("btn-google-login");
    const btnToken = $("btn-issue-token");
    const txtToken = $("token-output");
    const status = $("status");

    function setStatus(msg) {
      status.textContent = msg;
      console.log(msg);
    }

    // 로그인 상태 감지
    onAuthStateChanged(auth, (user) => {
      if (user) {
        setStatus(`로그인 계정: ${user.email} (uid=${user.uid})`);
        btnToken.disabled = false;
      } else {
        setStatus("현재 로그인된 관리자 계정이 없습니다. Google 로그인을 먼저 진행해 주세요.");
        btnToken.disabled = true;
        txtToken.value = "";
      }
    });

    // 1) Google 로그인
    btnGoogle.addEventListener("click", async () => {
      try {
        const provider = new GoogleAuthProvider();
        setStatus("Google 로그인 창을 여는 중입니다...");
        const result = await signInWithPopup(auth, provider);
        setStatus(`로그인 완료: ${result.user.email} (uid=${result.user.uid})`);
      } catch (err) {
        console.error(err);
        setStatus("Google 로그인에 실패했습니다.\n" + (err.message || err));
      }
    });

    // 2) Unity용 커스텀 토큰 발급
    btnToken.addEventListener("click", async () => {
      try {
        setStatus("Unity 연동 토큰을 발급하는 중입니다...");
        const issueCustomToken = httpsCallable(functions, "issueCustomToken");
        const res = await issueCustomToken();
        const customToken = res.data.customToken;

        txtToken.value = customToken;

        // 클립보드 복사 시도
        try {
          txtToken.focus();
          txtToken.select();
          document.execCommand("copy");
          setStatus("토큰 발급 완료! 클립보드에 복사되었습니다.\nUnity 클라이언트에 붙여넣어 주세요.");
        } catch {
          setStatus("토큰 발급 완료! 복사가 안 되면, 아래 내용을 수동으로 복사해 Unity에 붙여넣어 주세요.");
        }
      } catch (err) {
        console.error(err);
        setStatus("토큰 발급에 실패했습니다.\n" + (err.message || err));
      }
    });
  </script>
</body>
</html>
